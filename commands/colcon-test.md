---
name: colcon-test
description: Run ROS 2 workspace tests with colcon, auto-detecting workspace root and creating test script
argument-hint: "[colcon test options]"
allowed-tools:
  - Bash
  - Read
  - Write
  - Edit
---

Execute ROS 2 colcon test with automatic workspace detection and configuration.

## Steps to Execute

### 0. Find Git Repository Root

First, find the Git repository root directory:

- Traverse up from the current working directory to find the directory containing `.git`
- Start from current directory and check each parent directory for `.git` directory or file
- The first directory containing `.git` is the Git repository root
- If no `.git` found, display error: "Error: Not in a Git repository. Please run this command from within a Git repository."
- Store this path as the "file operation directory" for all test.sh operations

### 1. Find ROS 2 Workspace Root

**Check if `.ros_workspace.txt` exists in the Git repository root:**

- If `.ros_workspace.txt` exists in the Git repository root:
  - Read the workspace root path from the file
  - Verify the path exists and is a valid directory
  - Use this path as the workspace root
  - Inform user: "Using workspace root from .ros_workspace.txt: [path]"
- If `.ros_workspace.txt` does NOT exist:
  - Display error: "Error: .ros_workspace.txt not found. Please run /colcon-build first to set up the workspace."
  - Stop execution

### 2. Create/Update test.sh Script

Create or update the test script in Git repository root:

**Create/Update test.sh script:**
- Create `test.sh` in the **Git repository root** (found in step 0)
- Write the following shell script content:
  ```bash
  #!/bin/bash

  # Script to test ROS 2 workspace
  # Auto-generated by ros2-workspace Claude Code plugin
  # Usage: ./test.sh [colcon_test_args...]

  set -e

  # Get the directory where this script is located
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

  # Read ROS workspace directory from .ros_workspace.txt
  if [ ! -f "$SCRIPT_DIR/.ros_workspace.txt" ]; then
      echo "Error: .ros_workspace.txt not found!"
      echo "Please run /colcon-build first to set up the workspace."
      exit 1
  fi

  WORKSPACE_ROOT=$(cat "$SCRIPT_DIR/.ros_workspace.txt")

  # Change to ROS workspace directory
  cd "$WORKSPACE_ROOT"

  # Run colcon test
  echo "Testing ROS 2 workspace..."
  echo "Workspace: $WORKSPACE_ROOT"
  echo ""

  # Check if arguments are provided
  if [ $# -eq 0 ]; then
      echo "Error: No colcon test arguments specified!"
      echo "Usage: $0 [colcon_test_args...]"
      echo ""
      echo "Examples:"
      echo "  $0 --packages-select my_package"
      echo "  $0 --packages-up-to my_package"
      echo "  $0 --packages-up-to pkg1 pkg2"
      echo ""
      echo "Discovering available packages in workspace..."
      colcon list --names-only 2>/dev/null || echo "Failed to list packages"
      exit 1
  else
      echo "Running: colcon test $@"
      echo ""
      colcon test "$@"
  fi

  echo ""
  echo "Test completed!"
  echo ""
  echo "Viewing test results..."
  colcon test-result --all
  ```
- Make the script executable: `chmod +x test.sh`
- Inform user: "Updated test.sh script in [git-repo-root]" (always update to ensure latest version)

### 3. Update .gitignore

Ensure `test.sh` is ignored by git:

- Check if `.gitignore` exists in the **Git repository root** (found in step 0)
- Read the file and check if `test.sh` is already present
- If NOT present:
  - Append `test.sh` to `.gitignore`
  - Inform user: "Added test.sh to .gitignore in [git-repo-root]"
- If already present:
  - Inform user: "test.sh already in .gitignore"

### 4. Discover Packages in Current Directory

Find packages in current working directory:

- Execute `colcon list --names-only` in the **current working directory** (where Claude Code was started)
- Parse the output to get list of package names in current directory
- Store this list as "current_directory_packages"
- If packages found: Inform user: "Found [N] package(s) in current directory: [package names]"
- If no packages found: Inform user: "No packages found in current directory, will test entire workspace"

### 5. Execute Colcon Test via test.sh Script

Run the colcon test command through the test.sh script with intelligent package selection:

- Change to the **Git repository root** directory (where test.sh is located)
- Determine test command based on user arguments and current directory packages:

  **Case 1: User provided package selection arguments**
  - If user arguments contain `--packages-select`, `--packages-up-to`, `--packages-skip`, or `--packages-above`:
    - Use user-provided arguments as-is: `./test.sh [user-provided-arguments]`
    - Inform user: "Testing with user-specified package selection"

  **Case 2: Packages found in current directory (no user package selection)**
  - If "current_directory_packages" is not empty AND user did not specify package selection:
    - Test with `--packages-up-to` for current directory packages
    - Command: `./test.sh --packages-up-to [current_directory_packages] [other-user-arguments]`
    - Example: `./test.sh --packages-up-to pkg1 pkg2 pkg3`
    - Inform user: "Testing packages in current directory and their dependencies: [package names]"

  **Case 3: No packages in current directory (no user package selection)**
  - If "current_directory_packages" is empty AND user did not specify package selection:
    - Test entire workspace: `./test.sh [user-provided-arguments]`
    - Example: `./test.sh`
    - Inform user: "Testing entire workspace"

- Display the output of the test process to the user (including test results from test.sh)
- If test fails, show the error and exit code

**Note**: The test.sh script handles:
- Checking for .ros_workspace.txt existence
- Changing to the workspace root directory
- Running colcon test with the provided arguments
- Displaying test results with colcon test-result --all

## Important Notes

- All file operations (creating test.sh, modifying .gitignore) should happen in the **Git repository root** (directory containing .git)
- The command requires being run from within a Git repository
- Requires `.ros_workspace.txt` to exist (run `/colcon-build` first if it doesn't)
- **test.sh script**:
  - Auto-generated and **updated on every run** to ensure latest version
  - Stored in Git repository root
  - Reads workspace root from .ros_workspace.txt
  - Displays test results with colcon test-result --all after test completion
  - Added to .gitignore (local configuration)
- **Intelligent package selection**:
  - `colcon list --names-only` is executed in current directory
  - If packages are found in current directory, automatically tests only those packages and dependencies with `--packages-up-to`
  - If no packages in current directory, tests entire workspace
  - User can override with explicit `--packages-select` or `--packages-up-to` arguments
- Colcon test is executed via test.sh script from Git repository root
- Pass through any arguments the user provides to the colcon test command
